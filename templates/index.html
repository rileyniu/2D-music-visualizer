<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>CS 4621 Final Project</title>

    <!-- Bootstrap -->
    <link href="../static/bootstrap.min.css" rel="stylesheet">
    <link href="../static/cs4620.css" rel="stylesheet">
    <link href="../static/jquery-ui.min.css" rel="stylesheet">
    <link href="../static/jquery-ui.theme.min.css" rel="stylesheet">
    <link href="../static/jquery-ui.structure.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="container">
    <h1>CS 4621 Final Project <span class="subtitle">2D Music Visualizer</span></h1>
    <div id="content">
      <input type="file" id="thefile" accept="audio/*" />
      <canvas id="canvas"></canvas>
      <audio id="audio" controls></audio>
    </div>
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="../static/jquery-3.1.1.min.js"></script>
<script src="../static/jquery-ui.min.js"></script>
<script src="../static/gl-matrix-min.js"></script>
<script src="../static/preloadjs-0.6.2.min.js"></script>

<script type="text/javascript">

    // simple demo to use audio file
    window.onload = function() {
        var file = document.getElementById("thefile");
        var audio = document.getElementById("audio");

        file.onchange = function() {
            var files = this.files;
            audio.src = URL.createObjectURL(files[0]);
            audio.load();
            audio.play();
            var context = new AudioContext();
            var src = context.createMediaElementSource(audio);
            var analyser = context.createAnalyser();

            var canvas = document.getElementById("canvas");
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            var ctx = canvas.getContext("2d");

            src.connect(analyser);
            analyser.connect(context.destination);

            analyser.fftSize = 256;

            var bufferLength = analyser.frequencyBinCount;
            console.log(bufferLength);

            var dataArray = new Uint8Array(bufferLength);

            var WIDTH = canvas.width;
            var HEIGHT = canvas.height;

            var barWidth = (WIDTH / bufferLength) * 2.5;
            var barHeight;
            var x = 0;

            function renderFrame() {
                requestAnimationFrame(renderFrame);

                x = 0;

                analyser.getByteFrequencyData(dataArray);

                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, WIDTH, HEIGHT);

                for (var i = 0; i < bufferLength; i++) {
                    barHeight = dataArray[i];

                    var r = barHeight + (25 * (i/bufferLength));
                    var g = 250 * (i/bufferLength);
                    var b = 50;

                    ctx.fillStyle = "rgb(" + r + "," + g + "," + b + ")";
                    ctx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);

                    x += barWidth + 1;
                }
            }

            audio.play();
            renderFrame();
        };
    };

    // EXAMPLE: send post request to python
    $.ajax({
        url: "/_func/",
        type: "POST",
        success: function(){
            console.log("POST sent")
        }
    });

</script>


</body>
</html>
